- name: Enable NFV
  hosts: all

  tasks:

   # https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/chap-Guest_virtual_machine_device_configuration.html#proc-PCI_devices-Preparing_an_Intel_system_for_PCI_device_assignment
   - name: Enable Intel VT-d
     lineinfile: dest=/etc/default/grub regexp='(^GRUB_CMDLINE_LINUX=.*quiet)"' line='\1 intel_iommu=pt ixgbe.max_vfs=8"' backup=True backrefs=yes
     notify:
      - Regenerate config file
      - Rebuild initramfs
      - Reboot
      - Wait for server to come back

   - name: Enable Virtual Functionss parameter in module
     modprobe: name=ixgbe state=present params="max_vfs=8"

   - name: Make Virtual Functions parameter persistent
     lineinfile: dest=/etc/modprobe.d/ixgbe.conf line="options ixgbe max_vfs=8" state=present create=yes

   - name: Add vlan option to Neutron ML2
     ini_file: dest=/etc/neutron/plugin.ini section=ml2 option=tenant_network_types value="vxlan,vlan" backup=yes
   
   - name: Add sriovnicswitch option to mecanish_drivers to Neutron ML2
     ini_file: dest=/etc/neutron/plugin.ini section=ml2 option=mechanism_drivers value="openvswitch,sriovnicswitch" backup=yes

   - name: Add VLANs 16 to 22 to network_vlan_ranges Neutron ML2
     ini_file: dest=/etc/neutron/plugin.ini section=ml2_type_vlan option=network_vlan_ranges value="physnet1:16:22" backup=yes

  handlers:

   - name: Regenerate config file 
     command: grub2-mkconfig -o /boot/grub2/grub.cfg

   - name: Rebuild initramfs
     shell: |
            cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.$(date +%m-%d-%H%M%S).bak
            dracut -f -v

   - name: Reboot
     shell: sleep 2 && shutdown -r now "Ansible reboot"
     async: 1
     poll: 0
     ignore_errors: true
  
   - name: Wait for server to come back
     local_action: wait_for host={{ inventory_hostname }} state=started delay=30 timeout=300
